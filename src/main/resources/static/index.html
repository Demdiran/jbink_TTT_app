<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <title>Demo</title>
    <meta name="description" content=""/>
    <meta name="viewport" content="width=device-width"/>
    <base href="/"/>
    <link rel="stylesheet" href="indexStyle.css">
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
</head>
<body>
    <div id="app">
        <template v-if="!loggedin">
            <loginscreen v-on:logging-in="login"></loginscreen>
        </template>
        <template v-else>
            <accountview 
                v-bind:user="user" 
                v-bind:editingprofile="editingprofile" 
                v-on:edit-profile="editingprofile=true">
            </accountview>           
            <profileeditor 
                v-if="editingprofile" 
                v-bind:user="user" 
                v-on:change-profile-information="editprofile">
            </profileeditor>
            <logoutbutton 
                v-on:log-out="logout">
            </logoutbutton>
        </template>
        <tournamentlist
            id="tournamentlist" 
            v-bind:tournaments="tournaments"
            v-bind:loggedin="loggedin" 
            v-on:create-tournament="creatingtournament=true"
            v-on:sign-up="signUpForTournament">
        </tournamentlist>
        <tournamentcreator v-if="creatingtournament" v-on:create-tournament="createtournament"></tournamentcreator>
    </div>

      <script>
        Vue.component('loginscreen', {
            template: `
                <div class="unauthenticated">
                    Log in with Google: <a href="/oauth2/authorization/google">click here</a>
                </div>
            `
        });
        Vue.component('logoutbutton', {
            template: `
                <div v-on:click="logout" id="logoutbutton">log out</div>
            `,
            methods: {
                logout(){
                    this.$emit('log-out');
                }
            }
        });
        Vue.component('profileeditor', {
            props: [ 'user' ],
            data() {
                return {
                    username: "",
                    useradress: "",
                }
            },
            template: `
                <div class="informationcolumn">
                    <ul>
                        <li>Name: <input v-bind:placeholder="user.name" v-model="username"/></li>
                        <li>Rating: {{user.rating}}</li>
                        <li>Adress: <input v-bind:placeholder="user.adress" v-model="useradress" /></li>
                        <li>Tournaments: {{user.tournaments.map(tournament => tournament.name)}}</li>
                    </ul>
                    <button v-on:click="submit">Submit</button>
                </div>
            `,
            methods: {
                submit(){
                    this.$emit('change-profile-information', this.username, this.useradress);
                }
            }
        });
        Vue.component('tournamentcreator', {
            data(){
                return {
                    name: "",
                    club: "",
                    adress: "",
                    date: "",
                    maxParticipants: "",
                }
            },
            template: `
                <div class="informationcolumn">
                    <ul>
                        <li><input v-model="name" placeholder="Tournament name" /></li>
                        <li><input v-model="club" placeholder="Club" /></li>
                        <li><input v-model="adress" placeholder="Adress" /></li>
                        <li><input v-model="date" type="datetime-local" /></li>
                        <li><input v-model="maxParticipants" type="text" placeholder="Maximum number of participants" /></li>
                    </ul>
                    <button v-on:click="submit">Submit</button>
                </div>
            `,
            methods: {
                submit(){
                    this.$emit('create-tournament', this.name, this.club, this.adress, this.date, this.maxParticipants);
                }
            }
        });
        Vue.component('accountview', {
            props: [ 'user', 'editingprofile'],
            template: `
            <div class="informationcolumn">
                <ul>
                    <div class="informationbox">
                        <li>Name: {{user.name}}</li>
                        <li>Rating: {{user.rating}}</li>
                        <li>Adress: {{user.adress}}</li>
                        <li>Tournaments: {{user.tournaments.map(tournament => tournament.name)}}</li>
                    </div>
                </ul>
                <button v-if="!editingprofile" v-on:click="edit">Edit profile</button>
            </div>
            `,
            methods: {
                edit(){
                    this.$emit('edit-profile');
                }
            }
        });
        Vue.component('tournamentlist', {
            props: [ 'tournaments', 'loggedin' ],
            template: `
                <div class="informationcolumn">
                    <ul>
                        <li 
                            v-for="tournament in tournaments">
                                <div class="informationbox">
                                    {{tournament.club}}'s {{tournament.name}}</br>
                                    Where? {{tournament.adress}}</br>
                                    When? {{tournament.tournamentDate}}</br>
                                    Max. {{tournament.maxParticipants}} participants</br>
                                    <span v-if="loggedin">Distance is {{tournament.distanceToUser.toFixed(2)}} kilometers</span></br>
                                    <div class="button" v-if="loggedin" v-on:click="signup(tournament)">Sign up</div>
                                </div>
                        </li>
                    </ul>
                    <button v-on:click="createtournament" v-if="loggedin">New tournament</button>
                </div>
            `,
            methods: {
                createtournament(){
                    this.$emit('create-tournament');
                },
                signup(tournament){
                    this.$emit('sign-up', tournament);
                }
            }
        });
          const app = new Vue({
            el: "#app",
            data:{
                user : undefined,
                tournaments : undefined,
                editingprofile : false,
                creatingtournament : false
            },
            computed: {
                loggedin(){
                    return this.user != undefined;
                }
            },
            created:
                function () {
                    this.getTournaments();
                    this.login();
            },
            methods: {
                async login(){
                    console.log("logging in");
                    var cookie = this.getCookie("XSRF-TOKEN");
                    const response = await fetch("/user", {
                        method: 'GET',
                        headers: {
                            'Accept' : 'application/json',
                            'X-XSRF-TOKEN': cookie
                        }
                    });
                    if(response.status != 401){
                        const user = await response.json();
                        this.user = user;
                        console.log(user);
                    }
                },
                async logout(){
                    var cookie = this.getCookie("XSRF-TOKEN");
                    const response = await fetch("/logout", {
                        method: 'POST',
                        headers: {
                            'X-XSRF-TOKEN': cookie
                        }
                    });
                    this.user = undefined;
                },
                async editprofile(username, useradress){
                    this.user.name = username;
                    this.user.adress = useradress;
                    this.editingprofile = false;
                    var cookie = this.getCookie("XSRF-TOKEN");
                    const response = await fetch("/editprofile", {
                        method: 'POST',
                        headers: {
                            'X-XSRF-TOKEN': cookie,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(this.user)
                    });
                },
                async getTournaments(){
                    const response = await fetch("/tournaments", {
                        method: "GET",
                        headers: {
                            'Accept' : 'application/json'
                        }
                    });
                    const tournaments = await response.json();
                    this.tournaments = tournaments;
                },
                async createtournament(name, club, adress, date, maxParticipants){
                    this.creatingtournament = false;
                    var cookie = this.getCookie("XSRF-TOKEN");
                    const response = await fetch("/createTournament", {
                        method: "POST",
                        headers: {
                            'X-XSRF-TOKEN': cookie,
                            'Accept' : 'application/json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({name: name, club: club, adress: adress, tournamentDate: date, maxParticipants: maxParticipants})
                    });
                    tournament = await response.json();
                    this.tournaments.push(tournament);

                },
                async signUpForTournament(tournament){
                    console.log(tournament);
                    var cookie = this.getCookie("XSRF-TOKEN");
                    var response = await fetch("/signUpForTournament?tournamentID=" + tournament.tournamentID, {
                        method: "POST",
                        headers: {
                            'X-XSRF-TOKEN': cookie,
                            'Accept' : 'application/json'
                        }
                    });
                    user = await response.json();
                    this.user = user;
                    this.getTournaments();
                },
                getCookie(cname) {
                    var name = cname + "=";
                    var decodedCookie = decodeURIComponent(document.cookie);
                    var ca = decodedCookie.split(';');
                    for(var i = 0; i <ca.length; i++) {
                        var c = ca[i];
                        while (c.charAt(0) == ' ') {
                        c = c.substring(1);
                        }
                        if (c.indexOf(name) == 0) {
                        return c.substring(name.length, c.length);
                        }
                    }
                    return "";
                }
            }

          })
      </script>
</body>
</html>